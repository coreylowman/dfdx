have threads get elements in contiguous order and store into shared memory buffer

segmentSum(i, block_i, segment_size, buf)
    segment_i = i % segment_len
    segment_start = i - segment_i
    segment_end = segment_start + segment_size

    if block_i < segment_i
        segment_idx = block_i
        segment_len = segment_size - (segment_i - block_i)
    else if segment_end > BLOCK_SIZE
        segment_idx = segment_i
        segment_len = BLOCK_SIZE - segment_start
    else
        segment_idx = segment_i
        segment_len = segment_size

    stop = min(BLOCK_SIZE, segment_size)
    segment = buf + block_i - segment_idx

    for (unsigned int s=1; s < stop; s *= 2) {
        int index = 2 * s * tid;

        if (index < segmnet_len) {
            segment[index] += segment[index + s];
        }
        __syncthreads();
    }

    if segment_idx == 0
        out[i / segment_size] += segment[0]
